{

  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",

  "contentVersion": "1.0.0.0",

  "parameters": {

    "appName": {

      "type": "string",

      "metadata": {

        "description": "The name of the function app that you wish to create."

      }

    },

    "webAppGitHubUrl": {

        "type": "string",

        "defaultValue": "https://github.com/navzam/token-store-multi-service-sample"

    },

    "webAppGitHubBranch": {

        "type": "string",

        "defaultValue": "master"

    },

    "storageAccountType": {

      "type": "string",

      "defaultValue": "Standard_LRS",

      "allowedValues": ["Standard_LRS", "Standard_GRS", "Standard_RAGRS"],

      "metadata": {

        "description": "Storage Account type"

      }

    },

    "location": {

      "type": "string",

      "defaultValue": "[resourceGroup().location]",

      "metadata": {

        "description": "Location for all resources."

      }

    },

    "runtime": {

      "type": "string",

      "defaultValue": "node",

      "allowedValues": ["node", "dotnet", "java"],

      "metadata": {

        "description": "The language worker runtime to load in the function app."

      }

    }

  },

  "variables": {

    "functionAppName": "[parameters('appName')]",

    "applicationInsightsName": "[parameters('appName')]",

    "storageAccountName": "[concat(uniquestring(resourceGroup().id), 'azfunctions')]",

    "storageAccountid": "[concat(resourceGroup().id,'/providers/','Microsoft.Storage/storageAccounts/', variables('storageAccountName'))]",

    "functionWorkerRuntime": "[parameters('runtime')]"

  },

  "resources": [

    {

      "type": "Microsoft.Storage/storageAccounts",

      "name": "[variables('storageAccountName')]",

      "apiVersion": "2016-12-01",

      "location": "[parameters('location')]",

      "kind": "Storage",

      "sku": {

        "name": "[parameters('storageAccountType')]"

      }

    },

    {

      "apiVersion": "2015-08-01",

      "type": "Microsoft.Web/sites",

      "name": "[variables('functionAppName')]",

      "location": "[parameters('location')]",

      "kind": "functionapp",

      "dependsOn": [

        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"

      ],

      "resources": [

        {

            "apiVersion": "2016-03-01",

            "name": "appsettings",

            "type": "config",

            "location": "[parameters('webAppLocation')]",

            "properties": {

                "TokenStoreUrl": "[reference(variables('tokenStoreResourceId')).storeUrl]",

                "AzureAd:ClientId": "[parameters('aadAuthNClientId')]",

                "AzureAd:ClientSecret": "[parameters('aadAuthNClientSecret')]"

            },

            "dependsOn": [

                "[variables('webAppResourceId')]",

                "[variables('tokenStoreResourceId')]"

            ]

        },

        {

            "apiVersion": "2018-02-01",

            "name": "web",

            "type": "sourcecontrols",

            "dependsOn": [

                "[variables('webAppResourceId')]",

                "[resourceId('Microsoft.Web/Sites/config', parameters('webAppName'), 'appsettings')]"

            ],

            "properties": {

                "RepoUrl": "[parameters('webAppGitHubUrl')]",

                "branch": "[parameters('webAppGitHubBranch')]",

                "IsManualIntegration": true

            }

        }

    ],

      "properties": {

        "siteConfig": {

          "appSettings": [

            {

              "name": "AzureWebJobsDashboard",

              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(variables('storageAccountid'),'2015-05-01-preview').key1)]"

            },

            {

              "name": "AzureWebJobsStorage",

              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(variables('storageAccountid'),'2015-05-01-preview').key1)]"

            },

            {

              "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",

              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(variables('storageAccountid'),'2015-05-01-preview').key1)]"

            },

            {

              "name": "WEBSITE_CONTENTSHARE",

              "value": "[toLower(variables('functionAppName'))]"

            },

            {

              "name": "FUNCTIONS_EXTENSION_VERSION",

              "value": "~2"

            },

            {

              "name": "WEBSITE_NODE_DEFAULT_VERSION",

              "value": "8.11.1"

            },

            {

              "name": "APPINSIGHTS_INSTRUMENTATIONKEY",

              "value": "[reference(resourceId('microsoft.insights/components/', variables('applicationInsightsName')), '2015-05-01').InstrumentationKey]"

            },

            {

              "name": "FUNCTIONS_WORKER_RUNTIME",

              "value": "[variables('functionWorkerRuntime')]"

            }

          ]

        }

      }

    }
  ]

}